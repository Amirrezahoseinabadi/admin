<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت پشتیبانی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f3f4f6; color: #111827; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 500; }
        .status-open { background-color: #dcfce7; color: #166534; } .status-in-progress { background-color: #fef3c7; color: #92400e; }
        .status-answered { background-color: #e5e7eb; color: #374151; } .status-closed { background-color: #fee2e2; color: #991b1b; }
        
        .message-user { background-color: #ffffff; color: #1f2937; border-radius: 1rem 1rem 1rem 0.25rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-admin { background-color: #dbeafe; color: #1e40af; border-radius: 1rem 1rem 0.25rem 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sender-name { font-size: 0.8rem; font-weight: 500; margin-bottom: 0.25rem; padding: 0 0.5rem; }
        
        .ticket-list-item.active { background-color: #eef2ff; border-right: 4px solid #4f46e5; }
        #messages-container { background-color: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .unread-dot { width: 10px; height: 10px; background-color: #22c55e; border-radius: 9999px; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background-color: #9ca3af; border-radius: 50%; margin: 0 1px; animation: typing 1s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; } .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <div class="flex h-full">
        <!-- Sidebar -->
        <aside class="w-1/3 bg-white border-l border-gray-200 flex flex-col">
            <header class="p-4 border-b">
                <h1 class="text-xl font-bold">پنل مدیریت</h1>
                <nav class="mt-4 flex border-b">
                    <button id="nav-tickets" class="px-4 py-2 border-b-2 border-blue-500 font-semibold">تیکت‌ها</button>
                    <button id="nav-dashboard" class="px-4 py-2 text-gray-500">داشبورد</button>
                </nav>
            </header>
            
            <div id="tickets-view" class="flex flex-col flex-grow">
                <div class="p-4 border-b">
                    <input type="text" id="search-box" placeholder="جستجو..." class="w-full p-2 border rounded-md">
                    <div class="flex space-x-2 space-x-reverse mt-2">
                        <select id="filter-status" class="w-1/2 p-2 border rounded-md"><option value="all">همه وضعیت‌ها</option><option value="open">باز</option><option value="in-progress">در حال بررسی</option><option value="answered">پاسخ داده شد</option><option value="closed">بسته شده</option></select>
                        <select id="filter-department" class="w-1/2 p-2 border rounded-md"><option value="all">همه دپارتمان‌ها</option><option value="general">سوالات متفرقه</option><option value="technical">پشتیبانی فنی</option><option value="sales">بخش فروش</option></select>
                    </div>
                </div>
                <div id="tickets-list-container" class="p-2 space-y-2 flex-grow overflow-y-auto">
                    <div id="loading-skeleton" class="space-y-2"></div>
                </div>
            </div>

            <div id="dashboard-view" class="p-6 overflow-y-auto hidden bg-gray-50">
                <h2 class="text-xl font-bold mb-6 text-gray-800">داشبورد عملکرد پشتیبانی</h2>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <!-- Total Tickets -->
                    <div class="bg-white p-3 rounded-xl shadow-sm flex items-center">
                        <div class="bg-blue-100 text-blue-600 p-2 rounded-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        </div>
                        <div class="mr-3">
                            <p class="text-gray-500 text-sm">کل تیکت‌ها</p>
                            <p class="text-xl font-bold text-gray-900" id="stats-total"></p>
                        </div>
                    </div>
                    <!-- Open Tickets -->
                    <div class="bg-white p-3 rounded-xl shadow-sm flex items-center">
                        <div class="bg-green-100 text-green-600 p-2 rounded-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div class="mr-3">
                            <p class="text-gray-500 text-sm">تیکت‌های باز</p>
                            <p class="text-xl font-bold text-gray-900" id="stats-open"></p>
                        </div>
                    </div>
                    <!-- Closed Tickets -->
                    <div class="bg-white p-3 rounded-xl shadow-sm flex items-center">
                        <div class="bg-red-100 text-red-600 p-2 rounded-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div class="mr-3">
                            <p class="text-gray-500 text-sm">تیکت‌های بسته</p>
                            <p class="text-xl font-bold text-gray-900" id="stats-closed"></p>
                        </div>
                    </div>
                    <!-- Average Rating -->
                    <div class="bg-white p-3 rounded-xl shadow-sm flex items-center">
                        <div class="bg-yellow-100 text-yellow-600 p-2 rounded-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
                        </div>
                        <div class="mr-3">
                            <p class="text-gray-500 text-sm">میانگین رضایت</p>
                            <p class="text-xl font-bold text-gray-900" id="stats-rating"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <h3 class="font-semibold mb-4 text-gray-700">تفکیک وضعیت تیکت‌ها</h3>
                        <canvas id="status-chart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <h3 class="font-semibold mb-4 text-gray-700">تفکیک دپارتمان‌ها</h3>
                        <canvas id="department-chart"></canvas>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Conversation View -->
        <main id="conversation-view" class="w-2/3 flex flex-col bg-gray-50">
            <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                <p class="mt-4 text-lg">برای مشاهده گفتگو، یک تیکت را انتخاب کنید.</p>
            </div>
            
            <div id="conversation-content" class="hidden flex-1 flex flex-col">
                <header class="p-3 border-b bg-white z-10 flex justify-between items-center">
                    <div>
                        <h2 id="ticket-subject" class="font-bold text-lg"></h2>
                        <div class="flex items-center">
                            <p id="ticket-user-id" class="text-sm text-gray-500"></p>
                            <div id="typing-indicator" class="typing-indicator hidden ml-2"><span></span><span></span><span></span></div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <label for="ticket-status" class="font-medium text-sm">وضعیت:</label>
                        <select id="ticket-status" class="border rounded-md p-2 text-sm bg-transparent"><option value="open">باز</option><option value="in-progress">در حال بررسی</option><option value="answered">پاسخ داده شد</option><option value="closed">بسته شده</option></select>
                    </div>
                </header>
                
                <div id="messages-container" class="flex-1 p-4 overflow-y-auto space-y-4"></div>

                <footer class="p-4 bg-gray-100 border-t">
                    <form id="reply-form" class="flex items-center space-x-2 space-x-reverse">
                        <textarea id="reply-message" rows="1" class="flex-grow p-2 border rounded-md focus:ring-2 focus:ring-blue-500 bg-transparent" placeholder="پاسخ خود را بنویسید..."></textarea>
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-md hover:bg-blue-700 transition">ارسال</button>
                    </form>
                </footer>
            </div>
        </main>
    </div>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAjBkdCe-kJK2VFfM3lSFyFiFNXElOCPSg",
            authDomain: "support-app-final.firebaseapp.com",
            databaseURL: "https://support-app-final-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "support-app-final",
            storageBucket: "support-app-final.appspot.com",
            messagingSenderId: "220983533006",
            appId: "1:220983533006:web:87f404486afb9f6a06df9f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        let currentTicketId = null;
        let currentOpenTicketData = null;
        let messagesRef = null;
        let typingRef = null;
        let allTickets = {};
        let statusChartInstance = null;
        let departmentChartInstance = null;

        // DOM Elements
        const ticketsListContainer = document.getElementById('tickets-list-container');
        const welcomeMessage = document.getElementById('welcome-message');
        const conversationContent = document.getElementById('conversation-content');
        const ticketSubjectHeader = document.getElementById('ticket-subject');
        const ticketUserIdHeader = document.getElementById('ticket-user-id');
        const messagesContainer = document.getElementById('messages-container');
        const replyForm = document.getElementById('reply-form');
        const replyMessageInput = document.getElementById('reply-message');
        const ticketStatusSelect = document.getElementById('ticket-status');
        const searchBox = document.getElementById('search-box');
        const filterStatus = document.getElementById('filter-status');
        const filterDepartment = document.getElementById('filter-department');
        const loadingSkeleton = document.getElementById('loading-skeleton');
        const typingIndicator = document.getElementById('typing-indicator');

        const departmentMap = { general: 'سوالات متفرقه', technical: 'پشتیبانی فنی', sales: 'بخش فروش' };
        const statusMap = {
            open: { text: 'باز', className: 'status-open' },
            answered: { text: 'پاسخ داده شد', className: 'status-answered' },
            'in-progress': { text: 'در حال بررسی', className: 'status-in-progress' },
            closed: { text: 'بسته شده', className: 'status-closed' }
        };

        function createSkeleton() {
            return `
                <div class="p-4 border rounded-lg bg-white animate-pulse">
                    <div class="flex justify-between items-center"><div class="h-4 bg-gray-300 rounded w-3/4"></div><div class="h-4 bg-gray-300 rounded w-1/4"></div></div>
                    <div class="h-3 bg-gray-300 rounded w-1/2 mt-2"></div><div class="h-3 bg-gray-300 rounded w-1/3 mt-2"></div>
                </div>`;
        }

        function showSkeletonLoader() {
            let skeletons = '';
            for (let i = 0; i < 10; i++) skeletons += createSkeleton();
            loadingSkeleton.innerHTML = skeletons;
            loadingSkeleton.style.display = 'block';
        }

        function hideSkeletonLoader() {
            loadingSkeleton.style.display = 'none';
        }
        
        function applyFilters() {
            const searchTerm = searchBox.value.toLowerCase();
            const status = filterStatus.value;
            const department = filterDepartment.value;
            const filteredTickets = Object.keys(allTickets).filter(key => {
                const ticket = allTickets[key];
                const subjectMatch = ticket.subject.toLowerCase().includes(searchTerm);
                const userNameMatch = (ticket.user_name || '').toLowerCase().includes(searchTerm);
                const statusMatch = (status === 'all' || ticket.status === status);
                const departmentMatch = (department === 'all' || ticket.department === department);
                return (subjectMatch || userNameMatch) && statusMatch && departmentMatch;
            }).reduce((obj, key) => { obj[key] = allTickets[key]; return obj; }, {});
            renderTicketsList(filteredTickets);
        }

        function renderTicketsList(tickets) {
            hideSkeletonLoader();
            ticketsListContainer.innerHTML = '';
            const sortedTickets = Object.keys(tickets).map(key => ({ id: key, ...tickets[key] })).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            if (sortedTickets.length === 0) {
                ticketsListContainer.innerHTML = '<p class="p-4 text-center text-gray-500">هیچ تیکتی یافت نشد.</p>';
                return;
            }
            sortedTickets.forEach(ticket => {
                const statusInfo = statusMap[ticket.status] || { text: 'نامشخص' };
                const ticketElement = document.createElement('div');
                ticketElement.className = 'ticket-list-item border border-transparent rounded-lg p-3 bg-white cursor-pointer hover:border-blue-300';
                ticketElement.dataset.ticketId = ticket.id;
                if (ticket.id === currentTicketId) ticketElement.classList.add('active');
                const unreadIndicator = ticket.admin_unread ? '<div class="unread-dot ml-2"></div>' : '';
                ticketElement.innerHTML = `
                    <div class="flex justify-between items-center"><p class="font-bold truncate text-sm">${ticket.subject} <span class="font-normal text-gray-500">- ${ticket.user_name || 'کاربر'}</span></p><span class="status-badge flex-shrink-0 ${statusInfo.className}">${statusInfo.text}</span></div>
                    <div class="flex justify-between items-center mt-2"><p class="text-xs text-gray-500">${departmentMap[ticket.department] || 'نامشخص'}</p><div class="flex items-center">${unreadIndicator}<p class="text-xs text-gray-400">${new Date(ticket.created_at).toLocaleString('fa-IR')}</p></div></div>`;
                ticketElement.addEventListener('click', () => openConversation(ticket.id));
                ticketsListContainer.appendChild(ticketElement);
            });
        }
        
        function renderMessage(msg, ticketData) {
            const msgElement = document.createElement('div');
            const isUser = msg.sender === 'user';
            const messageAlign = isUser ? 'self-start' : 'self-end';
            const bubbleClass = isUser ? 'message-user' : 'message-admin';
            const nameAlign = isUser ? 'text-right' : 'text-left';
            const nameColor = isUser ? 'text-green-600' : 'text-blue-600';
            let senderName = isUser ? (ticketData.user_name || 'کاربر') : (departmentMap[ticketData.department] || 'پشتیبانی');
            msgElement.className = `flex flex-col max-w-lg w-full ${messageAlign}`;
            let messageContent = msg.text ? `<p class="text-sm break-words">${msg.text.replace(/\n/g, '<br>')}</p>` : msg.imageUrl ? `<a href="${msg.imageUrl}" target="_blank"><img src="${msg.imageUrl}" class="rounded-lg max-w-xs" alt="تصویر ارسال شده"></a>` : '';
            let receipt = '';
            if (!isUser) {
                const checkColor = msg.read_by_user ? 'text-blue-500' : 'text-gray-400';
                const checkCount = msg.read_by_user ? '✓✓' : '✓';
                receipt = `<span class="text-xs ${checkColor} mr-1">${checkCount}</span>`;
            }
            msgElement.innerHTML = `
                <p class="sender-name ${nameAlign} ${nameColor}">${senderName}</p><div class="p-3 rounded-lg ${bubbleClass}">${messageContent}</div>
                <span class="text-xs text-gray-500 mt-1 px-1">${receipt}${new Date(msg.created_at).toLocaleTimeString('fa-IR')}</span>`;
            messagesContainer.appendChild(msgElement);
        }

        function openConversation(ticketId) {
            if (messagesRef) messagesRef.off();
            if (typingRef) typingRef.off();
            currentTicketId = ticketId;
            db.ref(`tickets/${ticketId}`).update({ admin_unread: false });
            document.querySelectorAll('.ticket-list-item').forEach(el => el.classList.toggle('active', el.dataset.ticketId === ticketId));
            welcomeMessage.style.display = 'none';
            conversationContent.style.display = 'flex';
            db.ref(`tickets/${ticketId}`).on('value', (snapshot) => {
                currentOpenTicketData = snapshot.val();
                if (currentOpenTicketData) {
                    ticketSubjectHeader.textContent = currentOpenTicketData.subject;
                    ticketUserIdHeader.textContent = `کاربر: ${currentOpenTicketData.user_name || currentOpenTicketData.telegram_id}`;
                    ticketStatusSelect.value = currentOpenTicketData.status;
                }
            });
            messagesRef = db.ref(`messages/${ticketId}`);
            messagesRef.on('value', (snapshot) => {
                const messagesData = snapshot.val();
                messagesContainer.innerHTML = '';
                if (messagesData && currentOpenTicketData) {
                    Object.values(messagesData).sort((a, b) => new Date(a.created_at) - new Date(b.created_at)).forEach(msg => renderMessage(msg, currentOpenTicketData));
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
            typingRef = db.ref(`typing_status/${ticketId}`);
            typingRef.on('value', (snapshot) => {
                typingIndicator.classList.toggle('hidden', !snapshot.val());
            });
        }

        function renderDashboard() {
            const tickets = Object.values(allTickets);
            const totalTickets = tickets.length;
            const openTickets = tickets.filter(t => ['open', 'in-progress'].includes(t.status)).length;
            const ratedTickets = tickets.filter(t => t.rating);
            const avgRating = ratedTickets.length > 0 ? (ratedTickets.reduce((sum, t) => sum + t.rating, 0) / ratedTickets.length).toFixed(1) + ' / 5' : 'N/A';
            document.getElementById('stats-total').textContent = totalTickets;
            document.getElementById('stats-open').textContent = openTickets;
            document.getElementById('stats-closed').textContent = totalTickets - openTickets;
            document.getElementById('stats-rating').textContent = avgRating;
            const statusCtx = document.getElementById('status-chart').getContext('2d');
            const statusCounts = tickets.reduce((acc, t) => { acc[t.status] = (acc[t.status] || 0) + 1; return acc; }, {});
            if (statusChartInstance) statusChartInstance.destroy();
            statusChartInstance = new Chart(statusCtx, { type: 'doughnut', data: { labels: Object.keys(statusCounts).map(s => statusMap[s]?.text || s), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#dcfce7', '#fef3c7', '#e5e7eb', '#fee2e2'] }] } });
            const deptCtx = document.getElementById('department-chart').getContext('2d');
            const deptCounts = tickets.reduce((acc, t) => { acc[t.department] = (acc[t.department] || 0) + 1; return acc; }, {});
            if (departmentChartInstance) departmentChartInstance.destroy();
            departmentChartInstance = new Chart(deptCtx, { type: 'bar', data: { labels: Object.keys(deptCounts).map(d => departmentMap[d] || d), datasets: [{ label: 'تعداد تیکت', data: Object.values(deptCounts), backgroundColor: '#60a5fa' }] }, options: { indexAxis: 'y' } });
        }

        // Event Listeners
        searchBox.addEventListener('input', applyFilters);
        filterStatus.addEventListener('change', applyFilters);
        filterDepartment.addEventListener('change', applyFilters);
        replyMessageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); replyForm.dispatchEvent(new Event('submit')); } });
        replyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentTicketId) return;
            const messageText = replyMessageInput.value.trim();
            if (messageText === '') return;
            db.ref(`messages/${currentTicketId}`).push({ sender: 'admin', text: messageText, created_at: new Date().toISOString() });
            if (['open', 'in-progress'].includes(ticketStatusSelect.value)) {
                ticketStatusSelect.value = 'answered';
                db.ref(`tickets/${currentTicketId}`).update({ status: 'answered' });
            }
            replyMessageInput.value = '';
        });
        ticketStatusSelect.addEventListener('change', () => { if (currentTicketId) db.ref(`tickets/${currentTicketId}`).update({ status: ticketStatusSelect.value }); });
        
        const navTickets = document.getElementById('nav-tickets');
        const navDashboard = document.getElementById('nav-dashboard');
        const ticketsView = document.getElementById('tickets-view');
        const dashboardView = document.getElementById('dashboard-view');
        navTickets.addEventListener('click', () => {
            ticketsView.classList.remove('hidden'); dashboardView.classList.add('hidden');
            navTickets.classList.add('border-blue-500', 'font-semibold'); navTickets.classList.remove('text-gray-500');
            navDashboard.classList.remove('border-blue-500', 'font-semibold'); navDashboard.classList.add('text-gray-500');
        });
        navDashboard.addEventListener('click', () => {
            dashboardView.classList.remove('hidden'); ticketsView.classList.add('hidden');
            navDashboard.classList.add('border-blue-500', 'font-semibold'); navDashboard.classList.remove('text-gray-500');
            navTickets.classList.remove('border-blue-500', 'font-semibold'); navTickets.classList.add('text-gray-500');
            renderDashboard();
        });

        // Initial load
        showSkeletonLoader();
        db.ref('tickets').on('value', (snapshot) => {
            allTickets = snapshot.val() || {};
            applyFilters();
        }, (error) => {
            console.error("Firebase read failed: " + error.code);
            hideSkeletonLoader();
            ticketsListContainer.innerHTML = '<p class="p-4 text-center text-red-500">خطا در اتصال به دیتابیس. لطفا قوانین امنیتی Firebase را بررسی کنید.</p>';
        });
    </script>
</body>
</html>
