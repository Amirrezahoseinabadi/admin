<script type="module">
    const SUPABASE_URL = 'https://zguqvdisadlhvswsnlyy.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ticketsListSection = document.getElementById('tickets-list-section');
    const conversationSection = document.getElementById('conversation-section');
    const ticketsListContainer = document.getElementById('tickets-list-container');
    const noTicketsAdmin = document.getElementById('no-tickets-admin');
    const noTicketsText = document.getElementById('no-tickets-text');
    const welcomePanel = document.getElementById('welcome-panel');
    const conversationPanel = document.getElementById('conversation-panel');
    const conversationSubject = document.getElementById('conversation-subject');
    const conversationUserId = document.getElementById('conversation-user-id');
    const statusChanger = document.getElementById('status-changer');
    const conversationContainer = document.getElementById('conversation-container');
    const adminReplyForm = document.getElementById('admin-reply-form');
    const backToListBtn = document.getElementById('back-to-list-btn');
    
    // Fetch and Render Tickets
    async function fetchAndRenderAllTickets() {
        const { data: tickets, error } = await db.from('tickets').select('*, messages(*)');
        if (error) {
            console.error("Error fetching tickets: ", error);
            noTicketsText.textContent = 'خطا در بارگذاری تیکت‌ها.';
            return;
        }
        noTicketsAdmin.style.display = tickets.length === 0 ? 'flex' : 'none';
        if (tickets.length === 0) {
            noTicketsText.textContent = 'هیچ تیکتی یافت نشد.';
        }
        const ticketsWithUnread = tickets.map(ticket => {
            const lastAdminMessage = [...ticket.messages].filter(m => m.sender === 'admin').pop();
            let unreadCount = 0;
            if (lastAdminMessage) {
                unreadCount = ticket.messages.filter(m => m.sender === 'user' && new Date(m.created_at) > new Date(lastAdminMessage.created_at)).length;
            } else {
                unreadCount = ticket.messages.filter(m => m.sender === 'user').length;
            }
            return { ...ticket, unreadCount };
        });
        const sortedTickets = ticketsWithUnread.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
        ticketsListContainer.innerHTML = sortedTickets.map(ticket => renderTicketListItem(ticket)).join('');
        
        document.querySelectorAll('.ticket-list-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.ticket-list-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                openConversation(item.dataset.id);
            });
        });
    }
    
    // Render ticket list item
    function renderTicketListItem(data) {
        const status = statusMap[data.status] || { text: 'نامشخص', className: 'status-closed' };
        const lastUpdate = new Date(data.updated_at).toLocaleTimeString('fa-IR', {hour: '2-digit', minute:'2-digit'});
        return `<div class="ticket-list-item p-4 border-b border-gray-700 cursor-pointer hover:bg-gray-700 ${data.id === currentTicketId ? 'active' : ''}" data-id="${data.id}">
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-sm text-gray-100 truncate">${data.subject}</p>
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <span class="status-badge flex-shrink-0">${status.text}</span>
                            ${data.unreadCount > 0 ? `<div class="unread-badge">${data.unreadCount}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex justify-between items-baseline text-xs text-gray-400 mt-2">
                        <p>کاربر (${data.telegram_id || 'ناشناس'})</p>
                        <p>${lastUpdate}</p>
                    </div>
                </div>`;
    }
    
    // Open conversation when a ticket is selected
    async function openConversation(ticketId) {
        currentTicketId = ticketId;
        welcomePanel.style.display = 'none';
        conversationPanel.classList.remove('hidden');
        conversationPanel.classList.add('flex');
        
        if (window.innerWidth < 768) {
            ticketsListSection.style.display = 'none';
            conversationSection.style.display = 'flex';
        }
        
        if (messagesSubscription) messagesSubscription.unsubscribe();
        
        const { data: ticketData, error } = await db.from('tickets').select().eq('id', ticketId).single();
        if (error) return console.error(error);

        conversationSubject.textContent = ticketData.subject;
        conversationUserId.textContent = `کاربر (${ticketData.telegram_id || 'ناشناس'})`;
        statusChanger.value = ticketData.status;

        const renderMessages = (messages) => {
            const sortedMessages = messages.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
            conversationContainer.innerHTML = sortedMessages.map(msg => renderMessage(msg)).join('');
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
        };

        messagesSubscription = db
            .channel(`public:messages:ticket_id=eq.${ticketId}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `ticket_id=eq.${ticketId}` }, async payload => {
                 const { data, error } = await db.from('messages').select().eq('ticket_id', ticketId);
                 if (data) renderMessages(data);
            })
            .subscribe();

        const { data: initialMessages, error: msgError } = await db.from('messages').select().eq('ticket_id', ticketId);
        if (msgError) console.error(msgError);
        else renderMessages(initialMessages);
    }

    // Render message
    function renderMessage(data) {
        const messageClass = data.sender === 'user' ? 'message-user' : 'message-admin';
        const time = new Date(data.created_at).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit'});
        return `<div class="p-3 rounded-lg max-w-lg ${messageClass}">
                    <p class="whitespace-pre-wrap text-sm">${data.text}</p>
                    <span class="text-xs mt-2 block text-right opacity-70">${time}</span>
                </div>`;
    }

    fetchAndRenderAllTickets();
</script>
