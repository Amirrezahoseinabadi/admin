<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت پشتیبانی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f3f4f6; color: #111827; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 500; }
        .status-open { background-color: #dcfce7; color: #166534; }
        .status-pending_user_reply { background-color: #fef3c7; color: #92400e; }
        .status-closed { background-color: #fee2e2; color: #991b1b; }
        
        .message-user { background-color: #ffffff; color: #1f2937; border-radius: 1rem 1rem 1rem 0.25rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-admin { background-color: #dbeafe; color: #1e40af; border-radius: 1rem 1rem 0.25rem 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sender-name { font-size: 0.8rem; font-weight: 500; margin-bottom: 0.25rem; padding: 0 0.5rem; }
        
        .ticket-list-item.active { background-color: #eef2ff; border-right: 4px solid #4f46e5; }
        #messages-container { background-color: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .unread-dot { width: 10px; height: 10px; background-color: #22c55e; border-radius: 9999px; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="h-screen overflow-x-hidden">

    <div class="relative h-full w-full overflow-x-hidden md:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-full md:w-1/3 bg-white border-l border-gray-200 flex flex-col transition-transform duration-300 ease-in-out">
            <header class="p-4 border-b">
                <h1 class="text-xl font-bold">پنل مدیریت</h1>
                <nav class="mt-4 flex border-b">
                    <button id="nav-tickets" class="px-4 py-2 border-b-2 border-blue-500 font-semibold">تیکت‌ها</button>
                    <button id="nav-dashboard" class="px-4 py-2 text-gray-500">داشبورد</button>
                </nav>
            </header>
            
            <div id="tickets-view" class="flex flex-col flex-grow">
                <div class="p-4 border-b">
                    <input type="text" id="search-box" placeholder="جستجو..." class="w-full p-2 border rounded-md">
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 sm:space-x-reverse mt-2">
                        <select id="filter-status" class="w-full sm:w-1/2 p-2 border rounded-md">
                            <option value="all">همه وضعیت‌ها</option>
                            <option value="open">باز (در حال بررسی)</option>
                            <option value="pending_user_reply">در انتظار پاسخ کاربر</option>
                            <option value="closed">بسته شده</option>
                        </select>
                        <select id="filter-department" class="w-full sm:w-1/2 p-2 border rounded-md">
                            <option value="all">همه دپارتمان‌ها</option>
                            <option value="general">سوالات متفرقه</option>
                            <option value="technical">پشتیبانی فنی</option>
                            <option value="sales">بخش فروش</option>
                        </select>
                    </div>
                </div>
                <div id="tickets-list-container" class="p-2 space-y-2 flex-grow overflow-y-auto">
                    <div id="loading-skeleton" class="space-y-2"></div>
                </div>
            </div>

            <div id="dashboard-view" class="p-6 overflow-y-auto hidden bg-gray-50">
                 <!-- Dashboard content remains the same -->
            </div>
        </aside>

        <!-- Main Conversation View -->
        <main id="conversation-view" class="w-full h-full flex flex-col bg-gray-50 absolute top-0 right-0 md:relative md:w-2/3 transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-20">
            <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                <p class="mt-4 text-lg">برای مشاهده گفتگو، یک تیکت را انتخاب کنید.</p>
            </div>
            
            <div id="conversation-content" class="hidden flex-1 flex flex-col">
                <header class="p-3 border-b bg-white z-10 flex justify-between items-center">
                    <div class="flex items-center">
                        <button id="back-to-list-btn" class="md:hidden ml-2 p-2 rounded-full hover:bg-gray-100">
                            <svg class="w-6 h-6 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                        </button>
                        <div>
                            <h2 id="ticket-subject" class="font-bold text-lg"></h2>
                            <p id="ticket-user-id" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <label for="ticket-status" class="font-medium text-sm">وضعیت:</label>
                        <select id="ticket-status" class="border rounded-md p-2 text-sm bg-transparent">
                            <option value="open">باز (در حال بررسی)</option>
                            <option value="pending_user_reply">در انتظار پاسخ کاربر</option>
                            <option value="closed">بسته شده</option>
                        </select>
                    </div>
                </header>
                
                <div id="messages-container" class="flex-1 p-4 overflow-y-auto space-y-4"></div>

                <footer class="p-4 bg-gray-100 border-t">
                    <form id="reply-form" class="flex items-center space-x-2 space-x-reverse">
                        <textarea id="reply-message" rows="1" class="flex-grow p-2 border rounded-md focus:ring-2 focus:ring-blue-500 bg-transparent" placeholder="پاسخ خود را بنویسید..."></textarea>
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-md hover:bg-blue-700 transition">ارسال</button>
                    </form>
                </footer>
            </div>
        </main>
    </div>
    
    <script>
        const WORKER_URL = "https://support-api-worker.amiruserbot7.workers.dev";
        const firebaseConfig = {
            apiKey: "AIzaSyAjBkdCe-kJK2VFfM3lSFyFiFNXElOCPSg",
            authDomain: "support-app-final.firebaseapp.com",
            databaseURL: "https://support-app-final-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "support-app-final",
            storageBucket: "support-app-final.appspot.com",
            messagingSenderId: "220983533006",
            appId: "1:220983533006:web:87f404486afb9f6a06df9f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentTicketId = null;
        let allTickets = {};
        
        const ticketsListContainer = document.getElementById('tickets-list-container');
        const welcomeMessage = document.getElementById('welcome-message');
        const conversationView = document.getElementById('conversation-view');
        const conversationContent = document.getElementById('conversation-content');
        const ticketSubjectHeader = document.getElementById('ticket-subject');
        const ticketUserIdHeader = document.getElementById('ticket-user-id');
        const messagesContainer = document.getElementById('messages-container');
        const replyForm = document.getElementById('reply-form');
        const replyMessageInput = document.getElementById('reply-message');
        const ticketStatusSelect = document.getElementById('ticket-status');
        const searchBox = document.getElementById('search-box');
        const filterStatus = document.getElementById('filter-status');
        const filterDepartment = document.getElementById('filter-department');
        const loadingSkeleton = document.getElementById('loading-skeleton');
        const backToListBtn = document.getElementById('back-to-list-btn');

        const departmentMap = {
            general: 'سوالات متفرقه',
            technical: 'پشتیبانی فنی',
            sales: 'بخش فروش'
        };
        const statusMap = {
            open: { text: 'باز (در حال بررسی)', className: 'status-open' },
            pending_user_reply: { text: 'در انتظار پاسخ کاربر', className: 'status-pending_user_reply' },
            closed: { text: 'بسته شده', className: 'status-closed' }
        };

        function showSkeletonLoader() {
            let skeletons = '';
            for (let i = 0; i < 10; i++) {
                skeletons += `<div class="p-4 border rounded-lg bg-white animate-pulse"><div class="h-4 bg-gray-300 rounded w-3/4"></div><div class="h-3 bg-gray-300 rounded w-1/2 mt-2"></div></div>`;
            }
            loadingSkeleton.innerHTML = skeletons;
            loadingSkeleton.style.display = 'block';
        }

        function hideSkeletonLoader() {
            loadingSkeleton.style.display = 'none';
        }
        
        function applyFilters() {
            const searchTerm = searchBox.value.toLowerCase();
            const status = filterStatus.value;
            const department = filterDepartment.value;
            const filteredTickets = Object.keys(allTickets).filter(key => {
                const ticket = allTickets[key];
                const searchMatch = ticket.subject.toLowerCase().includes(searchTerm) || (ticket.user_name || '').toLowerCase().includes(searchTerm) || (ticket.telegram_id || '').toString().includes(searchTerm);
                const statusMatch = (status === 'all' || ticket.status === status);
                const departmentMatch = (department === 'all' || ticket.department === department);
                return searchMatch && statusMatch && departmentMatch;
            }).reduce((obj, key) => { obj[key] = allTickets[key]; return obj; }, {});
            renderTicketsList(filteredTickets);
        }

        function renderTicketsList(tickets) {
            hideSkeletonLoader();
            ticketsListContainer.innerHTML = '';
            const sortedTickets = Object.keys(tickets).map(key => ({ id: key, ...tickets[key] })).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            if (sortedTickets.length === 0) {
                ticketsListContainer.innerHTML = '<p class="p-4 text-center text-gray-500">هیچ تیکتی یافت نشد.</p>';
                return;
            }
            sortedTickets.forEach(ticket => {
                const statusInfo = statusMap[ticket.status] || { text: 'نامشخص', className: '' };
                const ticketElement = document.createElement('div');
                ticketElement.className = `ticket-list-item border border-transparent rounded-lg p-3 bg-white cursor-pointer hover:border-blue-300 ${ticket.id === currentTicketId ? 'active' : ''}`;
                ticketElement.dataset.ticketId = ticket.id;
                const unreadIndicator = ticket.admin_unread ? '<div class="unread-dot ml-2"></div>' : '';
                ticketElement.innerHTML = `<div class="flex justify-between items-center"><p class="font-bold truncate text-sm">${ticket.subject}</p><span class="status-badge flex-shrink-0 ${statusInfo.className}">${statusInfo.text}</span></div><div class="flex justify-between items-center mt-2"><p class="text-xs text-gray-500">${departmentMap[ticket.department] || 'نامشخص'}</p><div class="flex items-center">${unreadIndicator}<p class="text-xs text-gray-400">${new Date(ticket.created_at).toLocaleString('fa-IR')}</p></div></div>`;
                ticketElement.addEventListener('click', () => openConversation(ticket.id));
                ticketsListContainer.appendChild(ticketElement);
            });
        }
        
        function renderMessage(msg, ticketData) {
            const msgElement = document.createElement('div');
            const isUser = msg.sender === 'user';
            msgElement.className = `flex flex-col max-w-lg w-full ${isUser ? 'self-start' : 'self-end'}`;
            let senderName = isUser ? (ticketData.user_name || 'کاربر') : 'پشتیبانی';
            msgElement.innerHTML = `<p class="sender-name ${isUser ? 'text-right text-green-600' : 'text-left text-blue-600'}">${senderName}</p><div class="p-3 rounded-lg ${isUser ? 'message-user' : 'message-admin'}"><p class="text-sm break-words">${msg.text.replace(/\n/g, '<br>')}</p></div><span class="text-xs text-gray-500 mt-1 px-1">${new Date(msg.created_at).toLocaleTimeString('fa-IR')}</span>`;
            messagesContainer.appendChild(msgElement);
        }

        function openConversation(ticketId) {
            currentTicketId = ticketId;
            db.ref(`tickets/${ticketId}`).update({ admin_unread: false });

            if (window.innerWidth < 768) {
                conversationView.classList.remove('translate-x-full');
            }
            
            document.querySelectorAll('.ticket-list-item').forEach(el => el.classList.toggle('active', el.dataset.ticketId === ticketId));
            welcomeMessage.style.display = 'none';
            conversationContent.style.display = 'flex';
            
            db.ref(`tickets/${ticketId}`).on('value', (snapshot) => {
                const ticketData = snapshot.val();
                if (ticketData) {
                    ticketSubjectHeader.textContent = ticketData.subject;
                    ticketUserIdHeader.textContent = `کاربر: ${ticketData.user_name || ticketData.telegram_id}`;
                    ticketStatusSelect.value = ticketData.status;
                }
            });
            db.ref(`messages/${ticketId}`).on('value', (snapshot) => {
                const messagesData = snapshot.val();
                messagesContainer.innerHTML = '';
                if (messagesData && allTickets[ticketId]) {
                    Object.values(messagesData).sort((a, b) => new Date(a.created_at) - new Date(b.created_at)).forEach(msg => renderMessage(msg, allTickets[ticketId]));
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        function closeConversation() {
            if (window.innerWidth < 768) {
                conversationView.classList.add('translate-x-full');
            }
            currentTicketId = null;
        }

        replyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentTicketId) return;
            const messageText = replyMessageInput.value.trim();
            if (messageText === '') return;

            const payload = {
                ticket_id: currentTicketId,
                sender: 'admin',
                text: messageText,
            };

            try {
                const response = await fetch(`${WORKER_URL}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) throw new Error('خطا در ارسال پیام');
                
                // Set status to pending user reply after admin sends a message
                await fetch(`${WORKER_URL}/tickets/${currentTicketId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'pending_user_reply' }),
                });

                replyMessageInput.value = '';
            } catch (error) {
                console.error("Failed to send message:", error);
                alert('ارسال پیام با خطا مواجه شد.');
            }
        });

        // +++ START: EDITED CODE +++
        // Event listener for status change to notify the user
        ticketStatusSelect.addEventListener('change', async () => {
            if (!currentTicketId) return;
            const newStatus = ticketStatusSelect.value;
            
            try {
                const response = await fetch(`${WORKER_URL}/tickets/${currentTicketId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus }),
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'خطا در به‌روزرسانی وضعیت');
                }
                // The database will be updated via the worker, and the 'on.value' listener will catch it.
                // No need to manually update the DB here.
            } catch (error) {
                console.error('Failed to update status:', error);
                alert(` به‌روزرسانی وضعیت با خطا مواجه شد: ${error.message}`);
                // Revert dropdown if API call fails
                db.ref(`tickets/${currentTicketId}/status`).once('value', snapshot => {
                    ticketStatusSelect.value = snapshot.val();
                });
            }
        });
        // +++ END: EDITED CODE +++

        searchBox.addEventListener('input', applyFilters);
        filterStatus.addEventListener('change', applyFilters);
        filterDepartment.addEventListener('change', applyFilters);
        backToListBtn.addEventListener('click', closeConversation);

        // Initial load
        showSkeletonLoader();
        db.ref('tickets').on('value', (snapshot) => {
            allTickets = snapshot.val() || {};
            applyFilters();
        }, (error) => {
            console.error("Firebase read failed:", error.code);
            hideSkeletonLoader();
            ticketsListContainer.innerHTML = '<p class="p-4 text-center text-red-500">خطا در اتصال به دیتابیس.</p>';
        });
    </script>
</body>
</html>
