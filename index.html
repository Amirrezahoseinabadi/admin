<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت پشتیبانی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: #f3f4f6;
            color: #111827;
        }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 500; }
        .status-open { background-color: #dcfce7; color: #166534; } /* Green */
        .status-in-progress { background-color: #fef3c7; color: #92400e; } /* Yellow */
        .status-answered { background-color: #e5e7eb; color: #374151; } /* Gray */
        .status-closed { background-color: #fee2e2; color: #991b1b; } /* Red */
        
        .message-user { background-color: #ffffff; color: #1f2937; border-radius: 1rem 1rem 1rem 0.25rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-admin { background-color: #dbeafe; color: #1e40af; border-radius: 1rem 1rem 0.25rem 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sender-name { font-size: 0.8rem; font-weight: 500; margin-bottom: 0.25rem; padding: 0 0.5rem; }
        
        .ticket-list-item.active {
            background-color: #eef2ff;
            border-right: 4px solid #4f46e5;
        }
        #messages-container {
            background-color: #e5ddd5;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }
        #file-upload-label, #canned-responses-btn { cursor: pointer; }
        .unread-dot { width: 10px; height: 10px; background-color: #22c55e; border-radius: 9999px; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <div class="flex h-full">
        <!-- Sidebar for Tickets List -->
        <aside class="w-1/3 bg-white border-l border-gray-200 overflow-y-auto flex flex-col">
            <header class="p-4 border-b sticky top-0 bg-white z-10">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold">لیست تیکت‌ها</h1>
                </div>
                <div class="mt-4 space-y-2">
                    <input type="text" id="search-box" placeholder="جستجو..." class="w-full p-2 border rounded-md bg-transparent">
                    <div class="flex space-x-2 space-x-reverse">
                        <select id="filter-status" class="w-1/2 p-2 border rounded-md bg-transparent"><option value="all">همه وضعیت‌ها</option><option value="open">باز</option><option value="in-progress">در حال بررسی</option><option value="answered">پاسخ داده شد</option><option value="closed">بسته شده</option></select>
                        <select id="filter-department" class="w-1/2 p-2 border rounded-md bg-transparent"><option value="all">همه دپارتمان‌ها</option><option value="general">سوالات متفرقه</option><option value="technical">پشتیبانی فنی</option><option value="sales">بخش فروش</option></select>
                    </div>
                </div>
            </header>
            <div id="tickets-list-container" class="p-2 space-y-2 flex-grow">
                <!-- Skeleton Loader -->
                <div id="loading-skeleton" class="space-y-2"></div>
            </div>
        </aside>

        <!-- Main Conversation View -->
        <main id="conversation-view" class="w-2/3 flex flex-col bg-gray-50">
            <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                <p class="mt-4 text-lg">برای مشاهده گفتگو، یک تیکت را انتخاب کنید.</p>
            </div>
            
            <div id="conversation-content" class="hidden flex-1 flex flex-col">
                <header class="p-3 border-b bg-white z-10 flex justify-between items-center">
                    <div>
                        <h2 id="ticket-subject" class="font-bold text-lg"></h2>
                        <p id="ticket-user-id" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <label for="ticket-status" class="font-medium text-sm">وضعیت:</label>
                        <select id="ticket-status" class="border rounded-md p-2 text-sm bg-transparent"><option value="open">باز</option><option value="in-progress">در حال بررسی</option><option value="answered">پاسخ داده شد</option><option value="closed">بسته شده</option></select>
                    </div>
                </header>
                
                <div id="messages-container" class="flex-1 p-4 overflow-y-auto space-y-4"></div>

                <footer class="p-4 bg-gray-100 border-t">
                    <form id="reply-form" class="flex items-center space-x-2 space-x-reverse">
                        <button type="button" id="canned-responses-btn" class="p-2 rounded-full hover:bg-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                        </button>
                        <label id="file-upload-label" for="file-upload" class="p-2 rounded-full hover:bg-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        </label>
                        <input type="file" id="file-upload" class="hidden" accept="image/*">
                        
                        <textarea id="reply-message" rows="1" class="flex-grow p-2 border rounded-md focus:ring-2 focus:ring-blue-500 bg-transparent" placeholder="پاسخ خود را بنویسید..."></textarea>
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-md hover:bg-blue-700 transition">ارسال</button>
                    </form>
                </footer>
            </div>
        </main>
    </div>

    <!-- Canned Responses Modal -->
    <div id="canned-responses-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">پاسخ‌های آماده</h3>
            <div id="canned-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <button id="close-modal-btn" class="mt-4 bg-gray-200 px-4 py-2 rounded-md">بستن</button>
        </div>
    </div>
    
    <audio id="notification-sound" src="https://freesound.org/data/previews/415/415762_6142149-lq.mp3" preload="auto"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAjBkdCe-kJK2VFfM3lSFyFiFNXElOCPSg",
            authDomain: "support-app-final.firebaseapp.com",
            databaseURL: "https://support-app-final-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "support-app-final",
            storageBucket: "support-app-final.appspot.com",
            messagingSenderId: "220983533006",
            appId: "1:220983533006:web:87f404486afb9f6a06df9f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        let currentTicketId = null;
        let currentOpenTicketData = null;
        let messagesRef = null;
        let allTickets = {};

        // DOM Elements
        const ticketsListContainer = document.getElementById('tickets-list-container');
        const welcomeMessage = document.getElementById('welcome-message');
        const conversationContent = document.getElementById('conversation-content');
        const ticketSubjectHeader = document.getElementById('ticket-subject');
        const ticketUserIdHeader = document.getElementById('ticket-user-id');
        const messagesContainer = document.getElementById('messages-container');
        const replyForm = document.getElementById('reply-form');
        const replyMessageInput = document.getElementById('reply-message');
        const ticketStatusSelect = document.getElementById('ticket-status');
        const fileUploadInput = document.getElementById('file-upload');
        const searchBox = document.getElementById('search-box');
        const filterStatus = document.getElementById('filter-status');
        const filterDepartment = document.getElementById('filter-department');
        const loadingSkeleton = document.getElementById('loading-skeleton');
        const notificationSound = document.getElementById('notification-sound');

        // Maps & Data
        const departmentMap = { general: 'سوالات متفرقه', technical: 'پشتیبانی فنی', sales: 'بخش فروش' };
        const statusMap = {
            open: { text: 'باز', className: 'status-open' },
            answered: { text: 'پاسخ داده شد', className: 'status-answered' },
            'in-progress': { text: 'در حال بررسی', className: 'status-in-progress' },
            closed: { text: 'بسته شده', className: 'status-closed' }
        };
        const cannedResponses = [
            "سلام، از تماس شما با واحد پشتیبانی متشکریم. لطفاً منتظر بمانید.",
            "مشکل شما در حال بررسی توسط کارشناسان ما است.",
            "خواهش می‌کنم، اگر سوال دیگری دارید در خدمت شما هستیم.",
            "آیا مشکل شما برطرف شده است؟"
        ];

        function createSkeleton() {
            return `
                <div class="p-4 border rounded-lg bg-white animate-pulse">
                    <div class="flex justify-between items-center">
                        <div class="h-4 bg-gray-300 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-300 rounded w-1/4"></div>
                    </div>
                    <div class="h-3 bg-gray-300 rounded w-1/2 mt-2"></div>
                    <div class="h-3 bg-gray-300 rounded w-1/3 mt-2"></div>
                </div>
            `;
        }

        function showSkeletonLoader() {
            let skeletons = '';
            for (let i = 0; i < 10; i++) {
                skeletons += createSkeleton();
            }
            loadingSkeleton.innerHTML = skeletons;
            loadingSkeleton.style.display = 'block';
        }

        function hideSkeletonLoader() {
            loadingSkeleton.style.display = 'none';
        }

        function applyFilters() {
            const searchTerm = searchBox.value.toLowerCase();
            const status = filterStatus.value;
            const department = filterDepartment.value;

            const filteredTickets = Object.keys(allTickets).filter(key => {
                const ticket = allTickets[key];
                const subjectMatch = ticket.subject.toLowerCase().includes(searchTerm);
                const userNameMatch = (ticket.user_name || '').toLowerCase().includes(searchTerm);
                const statusMatch = (status === 'all' || ticket.status === status);
                const departmentMatch = (department === 'all' || ticket.department === department);
                return (subjectMatch || userNameMatch) && statusMatch && departmentMatch;
            }).reduce((obj, key) => {
                obj[key] = allTickets[key];
                return obj;
            }, {});

            renderTicketsList(filteredTickets);
        }

        function renderTicketsList(tickets) {
            hideSkeletonLoader();
            ticketsListContainer.innerHTML = '';

            const sortedTickets = Object.keys(tickets).map(key => ({ id: key, ...tickets[key] }))
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            if (sortedTickets.length === 0) {
                ticketsListContainer.innerHTML = '<p class="p-4 text-center text-gray-500">هیچ تیکتی با این مشخصات یافت نشد.</p>';
                return;
            }
            
            sortedTickets.forEach(ticket => {
                const statusInfo = statusMap[ticket.status] || { text: 'نامشخص', className: 'bg-gray-200 text-gray-800' };
                const ticketElement = document.createElement('div');
                ticketElement.className = 'ticket-list-item border border-transparent rounded-lg p-3 bg-white cursor-pointer hover:border-blue-300';
                ticketElement.dataset.ticketId = ticket.id;
                if (ticket.id === currentTicketId) ticketElement.classList.add('active');
                
                const unreadIndicator = ticket.admin_unread ? '<div class="unread-dot ml-2"></div>' : '';

                ticketElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center overflow-hidden">
                            <p class="font-bold truncate text-sm">${ticket.subject} <span class="font-normal text-gray-500">- ${ticket.user_name || 'کاربر'}</span></p>
                        </div>
                        <span class="status-badge flex-shrink-0 ${statusInfo.className}">${statusInfo.text}</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-500">${departmentMap[ticket.department] || 'نامشخص'}</p>
                        <div class="flex items-center">
                             ${unreadIndicator}
                            <p class="text-xs text-gray-400">${new Date(ticket.created_at).toLocaleString('fa-IR')}</p>
                        </div>
                    </div>
                `;
                ticketElement.addEventListener('click', () => openConversation(ticket.id));
                ticketsListContainer.appendChild(ticketElement);
            });
        }
        
        function renderMessage(msg, ticketData) {
            const msgElement = document.createElement('div');
            const isUser = msg.sender === 'user';
            
            const messageAlign = isUser ? 'self-start' : 'self-end';
            const bubbleClass = isUser ? 'message-user' : 'message-admin';
            const nameAlign = isUser ? 'text-right' : 'text-left';
            const nameColor = isUser ? 'text-green-600' : 'text-blue-600';

            let senderName = isUser ? (ticketData.user_name || 'کاربر') : (departmentMap[ticketData.department] || 'پشتیبانی');

            msgElement.className = `flex flex-col max-w-lg ${messageAlign} opacity-0 translate-y-2 transition-all duration-300`;
            
            let messageContent = msg.text ? `<p class="text-sm break-words">${msg.text.replace(/\n/g, '<br>')}</p>` : 
                                 msg.imageUrl ? `<a href="${msg.imageUrl}" target="_blank"><img src="${msg.imageUrl}" class="rounded-lg max-w-xs" alt="تصویر ارسال شده"></a>` : '';

            msgElement.innerHTML = `
                <p class="sender-name ${nameAlign} ${nameColor}">${senderName}</p>
                <div class="p-3 rounded-lg ${bubbleClass}">${messageContent}</div>
                <span class="text-xs text-gray-500 mt-1 px-1">${new Date(msg.created_at).toLocaleTimeString('fa-IR')}</span>
            `;
            messagesContainer.appendChild(msgElement);
            setTimeout(() => { msgElement.classList.remove('opacity-0', 'translate-y-2'); }, 10);
        }

        function openConversation(ticketId) {
            if (messagesRef) messagesRef.off();
            currentTicketId = ticketId;
            
            db.ref(`tickets/${ticketId}`).update({ admin_unread: false });

            document.querySelectorAll('.ticket-list-item').forEach(el => el.classList.toggle('active', el.dataset.ticketId === ticketId));

            welcomeMessage.style.display = 'none';
            conversationContent.style.display = 'flex';

            db.ref(`tickets/${ticketId}`).on('value', (snapshot) => {
                currentOpenTicketData = snapshot.val();
                if (currentOpenTicketData) {
                    ticketSubjectHeader.textContent = currentOpenTicketData.subject;
                    ticketUserIdHeader.textContent = `کاربر: ${currentOpenTicketData.user_name || currentOpenTicketData.telegram_id}`;
                    ticketStatusSelect.value = currentOpenTicketData.status;
                }
            });

            messagesRef = db.ref(`messages/${ticketId}`);
            messagesRef.on('value', (snapshot) => {
                const messagesData = snapshot.val();
                messagesContainer.innerHTML = '';
                if (messagesData && currentOpenTicketData) {
                    const sortedMessages = Object.values(messagesData).sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    sortedMessages.forEach(msg => renderMessage(msg, currentOpenTicketData));
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        // --- Event Listeners ---
        searchBox.addEventListener('input', applyFilters);
        filterStatus.addEventListener('change', applyFilters);
        filterDepartment.addEventListener('change', applyFilters);

        replyMessageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                replyForm.dispatchEvent(new Event('submit'));
            }
        });

        replyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentTicketId) return;
            const messageText = replyMessageInput.value.trim();
            if (messageText === '') return;

            db.ref(`messages/${currentTicketId}`).push({ sender: 'admin', text: messageText, created_at: new Date().toISOString() });
            if (['open', 'in-progress'].includes(ticketStatusSelect.value)) {
                ticketStatusSelect.value = 'answered';
                db.ref(`tickets/${currentTicketId}`).update({ status: 'answered' });
            }
            replyMessageInput.value = '';
        });

        ticketStatusSelect.addEventListener('change', () => {
            if (!currentTicketId) return;
            db.ref(`tickets/${currentTicketId}`).update({ status: ticketStatusSelect.value });
        });
        
        fileUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !currentTicketId) return;
            const filePath = `ticket_attachments/${currentTicketId}/${new Date().getTime()}_${file.name}`;
            const uploadTask = storage.ref(filePath).put(file);
            uploadTask.on('state_changed', null, 
                (error) => { console.error("Upload failed:", error); alert('آپلود عکس با خطا مواجه شد.'); }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        db.ref(`messages/${currentTicketId}`).push({ sender: 'admin', imageUrl: downloadURL, created_at: new Date().toISOString() });
                    });
                }
            );
            e.target.value = '';
        });

        // Canned Responses Logic
        const cannedModal = document.getElementById('canned-responses-modal');
        const cannedList = document.getElementById('canned-list');
        cannedResponses.forEach(text => {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.className = 'w-full text-right p-2 rounded-md hover:bg-gray-100';
            btn.onclick = () => {
                replyMessageInput.value += text;
                cannedModal.classList.add('hidden');
                replyMessageInput.focus();
            };
            cannedList.appendChild(btn);
        });
        document.getElementById('canned-responses-btn').onclick = () => cannedModal.classList.remove('hidden');
        document.getElementById('close-modal-btn').onclick = () => cannedModal.classList.add('hidden');

        // Initial load of tickets
        showSkeletonLoader();
        db.ref('tickets').on('value', (snapshot) => {
            const newTickets = snapshot.val() || {};
            if (Object.keys(allTickets).length > 0) {
                for (const ticketId in newTickets) {
                    if (newTickets[ticketId].admin_unread && (!allTickets[ticketId] || !allTickets[ticketId].admin_unread)) {
                        notificationSound.play().catch(e => console.log("Notification sound blocked by browser."));
                        break;
                    }
                }
            }
            allTickets = newTickets;
            applyFilters();
        });
    </script>
</body>
</html>
